<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Universe Modeler - Jadon Koegel (V.1)</title>
		<style>
			body { margin: 0; }
		</style>

		<!-- Virtual Method of using JS Files from: https://stackoverflow.com/questions/46349370/javascript-file-not-found-using-relative-path-during-flask-render-template -->
		<!-- here:-->
		<!-- <script src="{{ url_for('static', filename='js/massiveBody.js')}}"></script>
		<script src="{{ url_for('static', filename='js/three.js')}}"></script>

		<script src="{{ url_for('static', filename='js/OrbitControls.js')}}"></script> -->

		<!-- Import map code to allow for import of OrbitControls -->
		<!-- https://stackoverflow.com/questions/65697410/not-using-node-js-uncaught-typeerror-failed-to-resolve-module-specifier-thre -->
		<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.138.0/build/three.module.js",
					"OrbitControls": "https://unpkg.com/three@0.138.0/examples/jsm/controls/OrbitControls.js",
					"dat": "https://unpkg.com/dat.gui@0.7.7/build/dat.gui.module.js",
					"CSS2DRenderer": "https://unpkg.com/three@0.138.0/examples/jsm/renderers/CSS2DRenderer.js"
				}
			}
		</script>

		<!-- <script src="{{ url_for('static', filename='js/massiveBody.js')}}"></script> -->
	</head>
	<body>
		<!-- Direct Inclusiuon of Javascript Libraries for Local Hosting Testing  -->
		<!-- <script src="/static/js/massiveBody.js" type="module"></script> -->
		<!-- <script src="/static/js/three.js"></script> -->
		<!-- <script src="/static/js/OrbitControls.js"></script> -->
	
		<!-- Main Program Script Starts Here: -->
		<script type="module">
			import * as THREE from 'three';
			import {OrbitControls} from 'OrbitControls';
			import {massiveBody} from './static/js/massiveBody.js';
			import {GUI} from 'dat';
			import {CSS2DRenderer, CSS2DObject} from 'CSS2DRenderer';
			//import * as THREE from '/node_modules/three/build/three.module.js';

			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera( 75 /*(Field of View in deg.)*/, window.innerWidth / window.innerHeight /*Just keep these settings don't want image to look squished)*/, 0.1 /*(Near clipping distance)*/, 1000/*(Far clipping distance)*/ );

			const renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			// const helper = new THREE.CameraHelper( camera );
			// scene.add( helper );

			const controls = new OrbitControls( camera, renderer.domElement );

			//https://medium.com/nerd-for-tech/getting-started-with-your-first-three-js-project-part-two-the-build-3fd9a2f21418
			renderer.setClearColor("#121212"); //233143

			//Label Renderer for Planet Floating Statistics
			const labelRenderer = new CSS2DRenderer();
			labelRenderer.setSize(window.innerWidth, window.innerHeight);
			labelRenderer.domElement.style.position = "absolute";
			labelRenderer.domElement.style.top = "0px";
			document.body.appendChild(labelRenderer.domElement);
			labelRenderer.domElement.style.pointerEvents = 'none'

			//Simple Resize Event Listener: https://sbcode.net/view_source/multiplecontrols.html
			window.addEventListener('resize', onWindowResize, false)
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight
                camera.updateProjectionMatrix()
                renderer.setSize(window.innerWidth, window.innerHeight)
                render()
            }

			//First central sphere
			const geometry = new THREE.SphereGeometry(0.5, 32, 16);
			const material = new THREE.MeshLambertMaterial( { color: 0xe01000 /*Orange*/ } );
			const sun = new THREE.Mesh( geometry, material );
			scene.add( sun );
			Ignite(3);

			stars();
		
			//Controls Object
			const mainGui = new GUI();
			var zoomGuiButton;
			var zoomGuiParams;

			//Camera Postioning vectors
			camera.position.z = 18;
			const HOME = new THREE.Vector3(camera.position.x, camera.position.y, camera.position.z);
			controls.update();

			//Rendering Variables
			var play = true;
			var NUMPLANETS = 4;
			const ScaleFactor = 10;
			var zoom = -2; //Start zoom index at -2 so camera is only reverted once if no zoom mode is selected

			//Planet Labels
			var PlanetDivs = [];
			var PlanetLabels = [];

			//Math Constants
			const M = 1.989;
			const Me = 30;

			//Physcis Engines for each Planet
			var PlanetPhysics = [];
			PlanetPhysics[0] = new massiveBody("Mercury", 5.79, 10, 0, 0, 0, 0, 4.74, 4, M, Me);
			PlanetPhysics[1] = new massiveBody("Venus", 1.082, 11, 0, 0, 0, 0, 3.50, 4, M, Me);
			PlanetPhysics[2] = new massiveBody("Earth", 1.47095, 11, 0, 0, 0, 0, 3.0290, 4, M, Me);
			PlanetPhysics[3] = new massiveBody("Mars", 2.280, 11, 0, 0, 0, 0, 2.41, 4, M, Me);
			// PlanetPhysics[4] = new massiveBody("Mercury", 7.785, 11, 0, 0, 0, 0, 1.31, 4, M, Me);
			// PlanetPhysics[5] = new massiveBody("Mercury", 1.4320, 12, 0, 0, 0, 0, 9.7, 3, M, Me);
			// PlanetPhysics[6] = new massiveBody("Mercury", 2.8670, 12, 0, 0, 0, 0, 6.8, 3, M, Me);
			// PlanetPhysics[7] = new massiveBody("Mercury", 4.5150, 12, 0, 0, 0, 0, 5.4, 3, M, Me);
			// PlanetPhysics[8] = new massiveBody("Mercury", 5.9064, 12, 0, 0, 0, 0, 4.7, 3, M, Me);

			//Orbiting Body Geometry
			var Planets = [];
			var PlanetGeometry = new THREE.SphereGeometry(0.18, 32, 16);
			var PlanetMaterial = new THREE.MeshLambertMaterial( { color: 0x060404 /*Grey*/ } );
			for(var i = 0; i < NUMPLANETS; i++){
				Planets[i] = new THREE.Mesh(PlanetGeometry, PlanetMaterial);
			}
			for(var i = 0; i < NUMPLANETS; i++){
				scene.add( Planets[i] );
			}

			loadPlanetLabels();

			userControls();

			function animate() {
	
				if(play){
					for(var i = 0; i < NUMPLANETS; i++){
						PlanetPhysics[i].calcParams();
						Planets[i].position.x = PlanetPhysics[i].XAdj*ScaleFactor;
						Planets[i].position.y = PlanetPhysics[i].YAdj*ScaleFactor;
					}
			
				}
				
				if(zoom > -1) //zoom index 0, 1, 2, etc... (focused on one of the planetary bodies)
					cameraZoom(zoom);
				else {
					if(zoom == -2){ //Only revert camera position once (otherwise drag mechanics don't work)
						camera.position.copy(HOME);
						zoom = -1;
					}
					controls.update(); //zoom index -1: continue to update drag controls (base level for zoom controls)
				}

				updatePlanetLabels();

				requestAnimationFrame( animate );
				renderer.render ( scene, camera );
				labelRenderer.render(scene, camera);
			}

			animate();

			function Ignite(radius){
				const lights = [];
				for(i = 0; i <6; i++){
					lights[i] = new THREE.PointLight(0xCCFFFF, 8, 100);	
					
					if(i == 0){
						lights[i].position.set(radius, 0, 0);
						scene.add(lights[i]);
					}
					else if(i == 1){
						lights[i].position.set(-radius, 0, 0);
						scene.add(lights[i]);
					}
					else if(i == 2){
						lights[i].position.set(0, radius, 0);
						scene.add(lights[i]);
					}
					else if(i == 3){
						lights[i].position.set(0, -radius, 0);
						scene.add(lights[i]);
					}
					else if(i == 4){
						lights[i].position.set(0, 0, radius);
						scene.add(lights[i]);
					}
					else if(i == 5){
						lights[i].position.set(0, 0, -radius);
						scene.add(lights[i]);
					}
				}
			}

			function stars() {
				//Accidental Stars Function from THREE website:
				//https://threejs.org/docs/index.html?q=Geometry#api/en/materials/PointsMaterial

				const vertices = [];
				for ( let i = 0; i < 10000; i ++ ) {

					const x = THREE.MathUtils.randFloatSpread( 2000, 10000 );
					const y = THREE.MathUtils.randFloatSpread( 2000, 10000 );
					const z = THREE.MathUtils.randFloatSpread( 2000, 10000 );

					vertices.push( x, y, z );

				}
				const geometry = new THREE.BufferGeometry();
				geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( vertices, 3 ) );
				const material = new THREE.PointsMaterial( { color: 0x888888 } );
				const points = new THREE.Points( geometry, material );
				scene.add( points );
			}

			function pauseplay(){
				if(play)
					play = false;
				else
					play = true;
			}

			function userControls(){
				const newObject = mainGui.addFolder('New Planetary Body');
				const currentObjects = mainGui.addFolder('Show Current Planet Parameters');
				const zoomFolder = mainGui.addFolder('Zoom');
				var current = [];
				for(var i = 0; i < NUMPLANETS; i++)
					current[i] = false;

				//New Planet parameters accessed by GUI
				const userParams = {
					name: "New Planet",
					x: 0,
					xe: 0,
					y: 0,
					ye: 0,
					vx: 0,
					vxe: 0,
					vy: 0,
					vye: 0,
					newPlanet: function(){
						Planets[NUMPLANETS] = new THREE.Mesh(PlanetGeometry, PlanetMaterial);

						console.log("X: " + this.x + "e" + this.xe + " Y: " + this.y + "e" + this.ye + " VX: " + this.vx + "e" + this.vxe + " VY: " + this.vy + "e" +this.vye);
						
						PlanetPhysics[NUMPLANETS] = new massiveBody(this.name, this.x, this.xe, this.y, this.ye, this.vx, this.vxe, this.vy, this.vye, M, Me);

						//PlanetPhysics[NUMPLANETS]
						
						console.log("X: " +  PlanetPhysics[NUMPLANETS].X + " Xe: " + PlanetPhysics[NUMPLANETS].Xe + " Y: " + PlanetPhysics[NUMPLANETS].Y + " Ye: " + PlanetPhysics[NUMPLANETS].Ye + " VX: " + PlanetPhysics[NUMPLANETS].VX + " VXe: " + PlanetPhysics[NUMPLANETS].VXe + " " + " VY: " + PlanetPhysics[NUMPLANETS].VY + " VYe: " + PlanetPhysics[NUMPLANETS].VYe);

						currentObjects.add(PlanetPhysics[NUMPLANETS], 'clicked').name(PlanetPhysics[NUMPLANETS].Name).onChange(function(){
							updatePlanetLabels();
						});

						scene.add( Planets[NUMPLANETS] );

						NUMPLANETS++;
						loadPlanetLabels();
					},
					home: function(){
						for(let i = 0; i < NUMPLANETS; i++)
							PlanetPhysics[i].Zoom = false;
						zoom = -2;
					}
				};

				//Play/Pause Animation Function
				mainGui.add( {pauseplay}, 'pauseplay').name('\u23EF' + " Play/Pause");
				mainGui.add( userParams, 'home').name('Revert Camera');
	
				var t = 'n';
				newObject.add(userParams, 'name').name('New Planet Name');

				newObject.add( userParams, 'x', -9, 9, 0.01).name('X Position (meters)');
				newObject.add( userParams, 'xe', 0, 15, 1).name('X Modifier (x10' + t.sup() + ')');
				newObject.add( userParams, 'y', -9, 9, 0.01).name('Y Position (meters)');
				newObject.add( userParams, 'ye', 0, 15, 1).name('Y Modifier (x10' + t.sup() + ')');

				newObject.add( userParams, 'vx', -9, 9, 0.01).name('Initial X Velocity (m/s)');
				newObject.add( userParams, 'vxe', 0, 15, 1).name('X Velocity Modifier (x10' + t.sup() + ')');
				newObject.add( userParams, 'vy', -9, 9, 0.01).name('Initial Y Velocity (m/s)');
				newObject.add( userParams, 'vye', 0, 15, 1).name('Y Velocity Modifier (x10' + t.sup() + ')');
				
				newObject.add( userParams, 'newPlanet').name("Create New Planetary Body");
				function log(n){
					return n
				};
				
				//Planet Parameter Labels
				for(let i = 0; i < NUMPLANETS; i++){
					currentObjects.add(PlanetPhysics[i], 'clicked').name(PlanetPhysics[i].Name).onChange(function(){
						updatePlanetLabels();
					})
				};
				
				//Zoom Selection Controls
				for(let i = 0; i< NUMPLANETS; i++){
					zoomFolder.add( PlanetPhysics[i], 'Zoom').name(PlanetPhysics[i].Name).listen().onChange(function(){
						checkedZoom(i);
					})
				};
			}

			function loadPlanetLabels(){
				const sunDiv = document.createElement("div");
				sunDiv.className = "label";
				sunDiv.textContent = "Sun";
				sunDiv.style.color = "#FFFFFF";
				sunDiv.style.backgroundColor = '#303030';

				const sunLabel = new CSS2DObject(sunDiv);
				sunLabel.position.set(0, 1.5, 0);
				sun.add(sunLabel);

				for(let i = 0; i < NUMPLANETS; i++){
					var newPlanetDiv = document.createElement("div");
					newPlanetDiv.className = "label";
					newPlanetDiv.textContent = (PlanetPhysics[i].Name + ": " + '\r\n' + "X Position: " + PlanetPhysics[i].X.toPrecision(3) + "e" + PlanetPhysics[i].Xe + " m" + '\r\n' + "Y Position: " + PlanetPhysics[i].Y.toPrecision(3) + "e" +PlanetPhysics[i].Ye + " m");
					newPlanetDiv.style.color = "#FFFFFF";
					newPlanetDiv.style.backgroundColor = '#303030';
					PlanetDivs[i] = newPlanetDiv;

					const newPlanetLabel = new CSS2DObject(PlanetDivs[i]);
					newPlanetLabel.position.set(PlanetPhysics[i].XAdj*ScaleFactor, PlanetPhysics[i].YAdj*ScaleFactor, 0);
					PlanetLabels[i] = newPlanetLabel;
					Planets[i].add(PlanetLabels[i]);
				}
			}

			function updatePlanetLabels(){
				for(let i = 0; i < NUMPLANETS; i++){
					if(PlanetPhysics[i].clicked)
						PlanetDivs[i].style.visibility = "visible";
					else
						PlanetDivs[i].style.visibility = "hidden";
					PlanetDivs[i].textContent = (PlanetPhysics[i].Name + ": " + '\r\n' + "X Position: " + PlanetPhysics[i].X.toPrecision(3) + "e" + PlanetPhysics[i].Xe + " m" + '\r\n' + "Y Position: " + PlanetPhysics[i].Y.toPrecision(3) + "e" +PlanetPhysics[i].Ye + " m");
				}
			}

			function checkedZoom(p){
				//Uncheck rest of non-selected buttons
				for(let i = 0; i < NUMPLANETS; i++){
					if(i != p)
						PlanetPhysics[i].Zoom = false;
				}
				//Check for new checked button
				for(let i = 0; i < NUMPLANETS; i++){
					if(PlanetPhysics[i].Zoom == true){
						//Hide main view gui
						mainGui.hide();
						//Add new button scheme for zoomed plane
						zoomGuiButton = new GUI();
						zoomGuiParams = new GUI();
						zoomGuiParams.hide();
						zoomGuiButton.add({editPlanetOrbit}, 'editPlanetOrbit').name('Edit Planet Orbit');
						zoomGuiButton.add({editPlanetOrbitPausePlay}, 'editPlanetOrbitPausePlay').name('Back');
						zoom = p;
						break;
					}
					else //No new checked button
						zoom = -2;
				}
			};

			function cameraZoom(n){
				var v = new THREE.Vector3();
				v.x += Planets[n].position.x;
				v.y += Planets[n].position.y;
				v.z += Planets[n].position.z;
				camera.lookAt(v);

				camera.position.x = Planets[n].position.x;
				camera.position.y = Planets[n].position.y;
				camera.position.z = 1;
			}

			//Temporary Position/Velocity Paramters, saved when user enters zoom mode and attempts to edit current orbit paramters
			var tempX, tempXe, tempY, tempYe, tempVX, tempVXe, tempVY, tempVYe;

			function editPlanetOrbit(){
				zoomGuiButton.hide();
				zoomGuiParams.show();

				play = false;

				tempX = PlanetPhysics[zoom].X;
				tempXe = PlanetPhysics[zoom].Xe;
				tempY = PlanetPhysics[zoom].Y;
				tempYe = PlanetPhysics[zoom].Ye;
				tempVX = PlanetPhysics[zoom].VX;
				tempVXe = PlanetPhysics[zoom].VXe;
				tempVY = PlanetPhysics[zoom].VY;
				tempVYe = PlanetPhysics[zoom].VYe;

				var t = 'n';
				zoomGuiParams.add( PlanetPhysics[zoom], 'X', -9, 9, 0.01).name('X Position (meters)');
				zoomGuiParams.add( PlanetPhysics[zoom], 'Xe', 0, 15, 1).name('X Modifier (x10' + t.sup() + ')');
				zoomGuiParams.add( PlanetPhysics[zoom], 'Y', -9, 9, 0.01).name('Y Position (meters)');
				zoomGuiParams.add( PlanetPhysics[zoom], 'Ye', 0, 15, 1).name('Y Modifier (x10' + t.sup() + ')');

				zoomGuiParams.add( PlanetPhysics[zoom], 'VX', -9, 9, 0.01).name('Initial X Velocity (m/s)');
				zoomGuiParams.add( PlanetPhysics[zoom], 'VXe', 0, 15, 1).name('X Velocity Modifier (x10' + t.sup() + ')');
				zoomGuiParams.add( PlanetPhysics[zoom], 'VY', -9, 9, 0.01).name('Initial Y Velocity (m/s)');
				zoomGuiParams.add( PlanetPhysics[zoom], 'VYe', 0, 15, 1).name('Y Velocity Modifier (x10' + t.sup() + ')');

				zoomGuiParams.add( {editPlanetOrbitPausePlay}, 'editPlanetOrbitPausePlay').name("Apply");
				zoomGuiParams.add( {zoomCancel}, 'zoomCancel').name("Cancel");
			}

			function editPlanetOrbitPausePlay(){
				zoomGuiButton.hide();
				zoomGuiParams.hide();
				mainGui.show();
				zoom = -2;
				play = true;
				for(let i = 0; i < NUMPLANETS; i++)
					PlanetPhysics[i].Zoom = false;
			}

			function zoomCancel(){
				PlanetPhysics[zoom].X = tempX;
				PlanetPhysics[zoom].Xe = tempXe;
				PlanetPhysics[zoom].Y = tempY;
				PlanetPhysics[zoom].Ye = tempYe;
				PlanetPhysics[zoom].VX = tempVX;
				PlanetPhysics[zoom].VXe = tempVXe;
				PlanetPhysics[zoom].VY = tempVY;
				PlanetPhysics[zoom].VYe = tempVYe;

				zoomGuiButton.hide();
				zoomGuiParams.hide();
				mainGui.show();
				zoom = -2;
				play = true;
				for(let i = 0; i < NUMPLANETS; i++)
					PlanetPhysics[i].Zoom = false;
			}
		</script>
	</body>
	
</html>